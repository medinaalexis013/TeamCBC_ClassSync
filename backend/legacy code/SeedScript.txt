BEGIN;
SET search_path = app, public;

INSERT INTO departments(name, abbreviation, description)
VALUES ('Computer Engineering & Computer Science','CECS','CSULB CECS')
ON CONFLICT DO NOTHING;

INSERT INTO majors(name, total_units, department_id)
VALUES ('Computer Science B.S.', 120, (SELECT department_id FROM departments WHERE abbreviation='CECS'))
ON CONFLICT DO NOTHING;

INSERT INTO courses(department_id, course_num, title, description, units)
VALUES
((SELECT department_id FROM departments WHERE abbreviation='CECS'),'326','Operating Systems','Processes, IPC, scheduling',3),
((SELECT department_id FROM departments WHERE abbreviation='CECS'),'327','Introduction to Networks','Protocols and routing',3),
((SELECT department_id FROM departments WHERE abbreviation='CECS'),'475','.NET Software Development','ASP.NET Core and EF Core',3)
ON CONFLICT DO NOTHING;

INSERT INTO prerequisite(desired_course, prerequisite_course, minimum_grade)
SELECT c327.course_id, c326.course_id, 'C'
FROM (SELECT course_id FROM courses WHERE course_num='327') c327,
     (SELECT course_id FROM courses WHERE course_num='326') c326
ON CONFLICT DO NOTHING;

INSERT INTO course_major_requirement(course_id, major_id, requirement_type, notes)
SELECT c.course_id, m.major_id, 'REQUIRED', 'Core'
FROM courses c
JOIN majors m ON m.name='Computer Science B.S.'
WHERE c.course_num IN ('326','327','475')
ON CONFLICT DO NOTHING;

INSERT INTO professors(department_id, first_name, last_name, email, phone_number, avg_rating, ratings_count)
VALUES
((SELECT department_id FROM departments WHERE abbreviation='CECS'),'Frank','Murgolo','frank.murgolo@csulb.edu',NULL,NULL,0),
((SELECT department_id FROM departments WHERE abbreviation='CECS'),'Fahd','Albinali','fahd.albinali@csulb.edu',NULL,NULL,0)
ON CONFLICT DO NOTHING;

INSERT INTO users(first_name, last_name, email, password_hash, email_verified)
VALUES
('Justin','Nguyen','justin.nguyen@example.com','hash_justin',TRUE),
('Shane','Kerr','shane.kerr@example.com','hash_shane',TRUE),
('Samuel','Kim','samuel.kim@example.com','hash_samuel',TRUE),
('Evelyn','Hernandez','evelyn.hernandez@example.com','hash_evelyn',TRUE),
('Alexis','Medina','alexis.medina@example.com','hash_alexis',TRUE),
('Peter','Tran','peter.tran@example.com','hash_peter',TRUE)
ON CONFLICT DO NOTHING;

INSERT INTO user_major_declaration(user_id, major_id, date_declared, degree_type, is_primary)
SELECT u.user_id, m.major_id, DATE '2024-09-01', 'BACHELORS', TRUE
FROM users u CROSS JOIN majors m
WHERE m.name='Computer Science B.S.'
ON CONFLICT DO NOTHING;

INSERT INTO terms(code, name, starts_on, ends_on, add_drop_deadline, finals_week_start)
VALUES
('2025SP','Spring 2025', DATE '2025-01-20', DATE '2025-05-16', DATE '2025-02-03', DATE '2025-05-10'),
('2025FA','Fall 2025',   DATE '2025-08-25', DATE '2025-12-19', DATE '2025-09-08', DATE '2025-12-13')
ON CONFLICT DO NOTHING;

INSERT INTO sections(course_id, term_id, professor_id, section_num, instruction, capacity, enrolled_count, consent_required, waitlist_capacity, waitlist_count)
SELECT c.course_id, t.term_id, p.professor_id, 1, 'FACE_TO_FACE', 35, 0, FALSE, 20, 0
FROM courses c
JOIN terms t ON t.code='2025FA'
JOIN professors p ON p.email='frank.murgolo@csulb.edu'
WHERE c.course_num='326'
ON CONFLICT DO NOTHING;

INSERT INTO sections(course_id, term_id, professor_id, section_num, instruction, capacity, enrolled_count, consent_required, waitlist_capacity, waitlist_count)
SELECT c.course_id, t.term_id, p.professor_id, 1, 'FACE_TO_FACE', 35, 0, FALSE, 20, 0
FROM courses c
JOIN terms t ON t.code='2025FA'
JOIN professors p ON p.email='frank.murgolo@csulb.edu'
WHERE c.course_num='327'
ON CONFLICT DO NOTHING;

INSERT INTO sections(course_id, term_id, professor_id, section_num, instruction, capacity, enrolled_count, consent_required, waitlist_capacity, waitlist_count)
SELECT c.course_id, t.term_id, p.professor_id, 1, 'HYBRID', 35, 0, FALSE, 20, 0
FROM courses c
JOIN terms t ON t.code='2025FA'
JOIN professors p ON p.email='fahd.albinali@csulb.edu'
WHERE c.course_num='475'
ON CONFLICT DO NOTHING;

INSERT INTO section_meetings(section_id, day_of_week, start_time, end_time, room, campus)
SELECT s.section_id, 1, TIME '09:30', TIME '10:45', 'ECS-302', 'Main'
FROM sections s JOIN courses c ON s.course_id=c.course_id JOIN terms t ON s.term_id=t.term_id
WHERE c.course_num='326' AND t.code='2025FA' AND s.section_num=1
ON CONFLICT DO NOTHING;

INSERT INTO section_meetings(section_id, day_of_week, start_time, end_time, room, campus)
SELECT s.section_id, 3, TIME '09:30', TIME '10:45', 'ECS-302', 'Main'
FROM sections s JOIN courses c ON s.course_id=c.course_id JOIN terms t ON s.term_id=t.term_id
WHERE c.course_num='326' AND t.code='2025FA' AND s.section_num=1
ON CONFLICT DO NOTHING;

INSERT INTO section_meetings(section_id, day_of_week, start_time, end_time, room, campus)
SELECT s.section_id, 2, TIME '11:00', TIME '12:15', 'ECS-304', 'Main'
FROM sections s JOIN courses c ON s.course_id=c.course_id JOIN terms t ON s.term_id=t.term_id
WHERE c.course_num='327' AND t.code='2025FA' AND s.section_num=1
ON CONFLICT DO NOTHING;

INSERT INTO section_meetings(section_id, day_of_week, start_time, end_time, room, campus)
SELECT s.section_id, 4, TIME '11:00', TIME '12:15', 'ECS-304', 'Main'
FROM sections s JOIN courses c ON s.course_id=c.course_id JOIN terms t ON s.term_id=t.term_id
WHERE c.course_num='327' AND t.code='2025FA' AND s.section_num=1
ON CONFLICT DO NOTHING;

INSERT INTO section_meetings(section_id, day_of_week, start_time, end_time, room, campus)
SELECT s.section_id, 5, TIME '13:00', TIME '15:45', 'Hybrid', 'Online'
FROM sections s JOIN courses c ON s.course_id=c.course_id JOIN terms t ON s.term_id=t.term_id
WHERE c.course_num='475' AND t.code='2025FA' AND s.section_num=1
ON CONFLICT DO NOTHING;

INSERT INTO user_section_registrations(user_id, section_id)
SELECT u.user_id, s.section_id
FROM users u
JOIN sections s ON s.section_id IN (
  (SELECT s1.section_id FROM sections s1 JOIN courses c1 ON s1.course_id=c1.course_id JOIN terms t1 ON s1.term_id=t1.term_id WHERE c1.course_num='326' AND t1.code='2025FA' AND s1.section_num=1),
  (SELECT s2.section_id FROM sections s2 JOIN courses c2 ON s2.course_id=c2.course_id JOIN terms t2 ON s2.term_id=t2.term_id WHERE c2.course_num='327' AND t2.code='2025FA' AND s2.section_num=1)
)
WHERE u.email IN ('justin.nguyen@example.com','shane.kerr@example.com','samuel.kim@example.com','evelyn.hernandez@example.com','alexis.medina@example.com','peter.tran@example.com')
ON CONFLICT DO NOTHING;

INSERT INTO reviews(user_id, professor_id, course_id, description, rating, difficulty)
SELECT u.user_id,
       (SELECT professor_id FROM professors WHERE email='frank.murgolo@csulb.edu'),
       (SELECT course_id FROM courses WHERE course_num='326'),
       'Great lectures', 5, 3
FROM users u
WHERE u.email='justin.nguyen@example.com'
ON CONFLICT DO NOTHING;

COMMIT;
